# LOCALTRIAGE - Architecture Diagram

## System Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                              LOCALTRIAGE PLATFORM                             │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │                         PRESENTATION LAYER                              │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │  │
│  │  │                    Streamlit Dashboard                           │   │  │
│  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │   │  │
│  │  │  │  New Ticket  │ │ Ticket List  │ │  Analytics   │            │   │  │
│  │  │  │    Triage    │ │   Browser    │ │  Dashboard   │            │   │  │
│  │  │  └──────────────┘ └──────────────┘ └──────────────┘            │   │  │
│  │  └─────────────────────────────────────────────────────────────────┘   │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                      │                                       │
│                                      ▼                                       │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │                           API LAYER (FastAPI)                          │  │
│  │                                                                        │  │
│  │   /health    /triage    /draft     /similar    /feedback   /metrics   │  │
│  │      │          │          │           │           │           │      │  │
│  └──────┼──────────┼──────────┼───────────┼───────────┼───────────┼──────┘  │
│         │          │          │           │           │           │         │
│  ┌──────┴──────────┴──────────┴───────────┴───────────┴───────────┴──────┐  │
│  │                          SERVICE LAYER                                 │  │
│  │                                                                        │  │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────┐   │  │
│  │  │  TRIAGE MODULE │  │ RETRIEVAL MOD. │  │    RAG DRAFTER MODULE  │   │  │
│  │  │                │  │                │  │                        │   │  │
│  │  │ ┌────────────┐ │  │ ┌────────────┐ │  │ ┌────────────────────┐ │   │  │
│  │  │ │  Baseline  │ │  │ │   BM25/    │ │  │ │   LLM Client       │ │   │  │
│  │  │ │ Classifier │ │  │ │    FTS     │ │  │ │  (OpenAI compat)   │ │   │  │
│  │  │ │ (TF-IDF +  │ │  │ └────────────┘ │  │ └────────────────────┘ │   │  │
│  │  │ │  LogReg)   │ │  │       │        │  │          │             │   │  │
│  │  │ └────────────┘ │  │       │        │  │          ▼             │   │  │
│  │  │       │        │  │       ▼        │  │ ┌────────────────────┐ │   │  │
│  │  │       │        │  │ ┌────────────┐ │  │ │  Prompt Builder    │ │   │  │
│  │  │       ▼        │  │ │   Vector   │ │  │ │  + Citation Engine │ │   │  │
│  │  │ ┌────────────┐ │  │ │   Search   │ │  │ └────────────────────┘ │   │  │
│  │  │ │  Category  │ │  │ │  (Dense)   │ │  │          │             │   │  │
│  │  │ │  Priority  │ │  │ └────────────┘ │  │          ▼             │   │  │
│  │  │ │ Prediction │ │  │       │        │  │ ┌────────────────────┐ │   │  │
│  │  │ └────────────┘ │  │       │        │  │ │  Draft Response    │ │   │  │
│  │  │                │  │       ▼        │  │ │  + Confidence      │ │   │  │
│  │  └────────────────┘  │ ┌────────────┐ │  │ └────────────────────┘ │   │  │
│  │                      │ │  Hybrid    │ │  │                        │   │  │
│  │                      │ │ Retriever  │ │  └────────────────────────┘   │  │
│  │                      │ │   (RRF)    │ │                               │  │
│  │                      │ └────────────┘ │                               │  │
│  │                      └────────────────┘                               │  │
│  │                                                                        │  │
│  │  ┌────────────────────────────────────────────────────────────────┐   │  │
│  │  │                     EVALUATION MODULE                           │   │  │
│  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────────────┐    │   │  │
│  │  │  │   Routing    │ │  Retrieval   │ │      Draft           │    │   │  │
│  │  │  │  Evaluator   │ │  Evaluator   │ │    Evaluator         │    │   │  │
│  │  │  │              │ │              │ │                      │    │   │  │
│  │  │  │ • Accuracy   │ │ • Recall@k   │ │ • Rubric Scoring     │    │   │  │
│  │  │  │ • F1 Score   │ │ • MRR        │ │ • Citation Quality   │    │   │  │
│  │  │  │ • Confusion  │ │ • nDCG       │ │ • Groundedness       │    │   │  │
│  │  │  └──────────────┘ └──────────────┘ └──────────────────────┘    │   │  │
│  │  └────────────────────────────────────────────────────────────────┘   │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                      │                                       │
│                                      ▼                                       │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │                           DATA LAYER                                   │  │
│  │                                                                        │  │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────┐   │  │
│  │  │   PostgreSQL   │  │     Qdrant     │  │    Model Storage       │   │  │
│  │  │                │  │  Vector Store  │  │                        │   │  │
│  │  │ • tickets      │  │                │  │ • Embedding Model      │   │  │
│  │  │ • kb_articles  │  │ • KB chunk     │  │   (Qwen3-Emb-8B)      │   │  │
│  │  │ • kb_chunks    │  │   embeddings   │  │                        │   │  │
│  │  │ • drafts       │  │ • 4096-dim     │  │ • Classifier Model     │   │  │
│  │  │ • feedback     │  │   vectors      │  │   (TF-IDF + LogReg)    │   │  │
│  │  │ • metrics      │  │ • HNSW index   │  │                        │   │  │
│  │  │ • FTS indices  │  │                │  │ • LLM (external)       │   │  │
│  │  └────────────────┘  └────────────────┘  └────────────────────────┘   │  │
│  │                                                                        │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                           INFRASTRUCTURE LAYER                               │
│                                                                              │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────────────┐ │
│  │   vLLM / llama │  │   Embedding    │  │        Monitoring              │ │
│  │      Server    │  │    Service     │  │                                │ │
│  │                │  │                │  │  ┌────────────┐ ┌────────────┐ │ │
│  │ • Qwen2.5-14B  │  │ • Qwen3-Emb-8B│  │  │ Prometheus │ │  Grafana   │ │ │
│  │   -Instruct    │  │ • FastAPI      │  │  └────────────┘ └────────────┘ │ │
│  │ • OpenAI API   │  │ • Batched      │  │                                │ │
│  │   compatible   │  │   inference    │  └────────────────────────────────┘ │
│  └────────────────┘  └────────────────┘                                     │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                          Docker Compose                               │   │
│  │   postgres | qdrant | llm-cpu/gpu | embeddings | api | dashboard     │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────────────────────┘
```

## Data Flow: Ticket Processing

```
┌─────────┐     ┌──────────┐     ┌───────────┐     ┌────────────┐     ┌─────────┐
│ Incoming│     │  Triage  │     │  Hybrid   │     │    RAG     │     │ Response│
│  Ticket │────▶│  Router  │────▶│ Retriever │────▶│  Drafter   │────▶│  Draft  │
└─────────┘     └──────────┘     └───────────┘     └────────────┘     └─────────┘
                    │                 │                  │
                    ▼                 ▼                  ▼
               ┌─────────┐      ┌──────────┐      ┌───────────┐
               │Category │      │Top-k KB  │      │Draft Text │
               │Priority │      │ Chunks   │      │+ Citations│
               │Confidence│     │+ Scores  │      │+Confidence│
               └─────────┘      └──────────┘      └───────────┘
```

## Hybrid Retrieval Flow

```
                    ┌──────────────┐
                    │    Query     │
                    └──────┬───────┘
                           │
            ┌──────────────┼──────────────┐
            │              │              │
            ▼              │              ▼
    ┌───────────────┐      │      ┌───────────────┐
    │  BM25/FTS     │      │      │    Dense      │
    │  (Sparse)     │      │      │   (Vector)    │
    │               │      │      │               │
    │ PostgreSQL    │      │      │   Qdrant/     │
    │  tsvector     │      │      │    FAISS      │
    └───────┬───────┘      │      └───────┬───────┘
            │              │              │
            │       ┌──────┴──────┐       │
            │       │             │       │
            └──────▶│ RRF Fusion  │◀──────┘
                    │             │
                    │ 1/(k+rank)  │
                    └──────┬──────┘
                           │
                           ▼
                    ┌──────────────┐
                    │  Merged &    │
                    │  Re-ranked   │
                    │   Results    │
                    └──────────────┘
```

## Component Dependencies

```
                     ┌──────────────┐
                     │   Streamlit  │
                     │     UI       │
                     └──────┬───────┘
                            │
                            ▼
                     ┌──────────────┐
                     │   FastAPI    │
                     │     API      │
                     └──────┬───────┘
                            │
          ┌─────────────────┼─────────────────┐
          │                 │                 │
          ▼                 ▼                 ▼
   ┌────────────┐    ┌────────────┐    ┌────────────┐
   │   Triage   │    │ Retrieval  │    │    RAG     │
   │   Module   │    │   Module   │    │   Module   │
   └──────┬─────┘    └──────┬─────┘    └──────┬─────┘
          │                 │                 │
          │                 │                 │
          │    ┌────────────┴─────┐           │
          │    │                  │           │
          ▼    ▼                  ▼           ▼
   ┌────────────┐          ┌────────────┐ ┌──────────┐
   │ PostgreSQL │          │   Qdrant   │ │   LLM    │
   │            │          │            │ │  Server  │
   └────────────┘          └────────────┘ └──────────┘
```

---

*This architecture supports horizontal scaling by running multiple API containers behind a load balancer.*
